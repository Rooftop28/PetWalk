这是一个整合了**基础功能**与最新讨论的**游戏化系统（寻宝猎人+动态状态机）**的完整 PRD 文档。

你可以直接复制下面的 Markdown 内容，保存为 `PetWalk_PRD_v1.1.md`，作为你开发 v1.0 MVP 的核心指导文档。

-----

# 📝 产品需求文档 (PRD) - PetWalk

| 项目名称 | PetWalk | 版本号 | v1.1 (Gamification MVP) |
| :--- | :--- | :--- | :--- |
| **项目代号** | CyberPup | **平台** | iOS & watchOS |
| **状态** | 开发进行中 | **核心技术** | SwiftUI, Vision, HealthKit, WatchConnectivity |
| **更新日期** | 2025-12-08 | **更新内容** | 新增寻宝猎人、骨头币系统、动态状态机 |

-----

## 1. 产品概述 (Overview)

### 1.1 产品愿景

打造一款“把自家毛孩子装进 Apple Watch”的陪伴型工具应用。不仅记录遛狗数据，更通过游戏化机制（RPG寻宝、电子宠物状态），将枯燥的日常遛狗转化为一场充满惊喜的探险，增强用户的情感连接与运动动力。

### 1.2 核心价值主张 (USP)

  * **专属感**：使用用户真实宠物的照片（Vision 自动抠图），而非通用卡通形象。
  * **游戏化激励**：独创“寻宝猎人”系统，遛狗即探险，随机掉落虚拟物品。
  * **情感反馈**：宠物状态与运动频率挂钩，不遛狗宠物会“郁闷”，激发责任感。

-----

## 2. 用户流程 (User Flow)

### 2.1 首次配置 (Onboarding)

1.  用户授权相册、健康 (HealthKit)、通知权限。
2.  上传宠物照片 -> 系统自动抠图生成贴纸 -> 同步至 Apple Watch。

### 2.2 日常循环 (The Loop)

1.  **查看状态**：用户打开 App/手表，根据上次遛狗时间看到宠物的不同状态（开心/期待/郁闷）。
2.  **行动**：点击“GO”开始遛狗。
3.  **过程**：Watch/iOS 实时记录距离与时长。
4.  **结算 (爽点)**：
      * 显示本次里程与“骨头币”收益。
      * **触发寻宝**：随机判定是否获得“掉落物”（如：捡到一根枯树枝）。
5.  **成长**：查看收藏柜，消耗骨头币抽取未获得的物品。

-----

## 3. 功能需求说明 (Functional Requirements)

### 3.1 iOS 核心功能

| 模块 | 功能点 | 详细逻辑/规则 | 优先级 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| **首页** | **智能抠图** | 调用 `VNGenerateForegroundInstanceMaskRequest` (iOS 17+) 实现一键去背，保存 PNG 到本地。 | P0 | ✅ 已完成 |
| **首页** | **动态状态机** | 根据 `lastWalkDate` 改变宠物 UI：<br>- **<3h (兴奋)**: 粒子特效/跳动快。<br>- **<24h (开心)**: 正常状态。<br>- **24-48h (期待)**: 歪头/叹气气泡。<br>- **>48h (郁闷)**: 变灰/背对屏幕。 | **P0** | ✅ 已完成 |
| **首页** | **健康数据** | 读取 HealthKit 当日步行距离与步数，更新绿色进度环。 | P0 | ✅ 已完成 |
| **首页** | **Watch同步** | 使用 `WatchConnectivity` (`transferFile`) 将宠物贴纸发送给手表。 | P0 | ✅ 已完成 |
| **足迹** | **回忆日历** | 自定义 Grid 视图。无记录(灰) -> 有记录无图(绿爪) -> 有记录有图(显示缩略图+绿边框)。支持点击查看大图。 | P1 | ✅ 已完成 |
| **足迹** | **数据持久化** | 使用 `Codable` 将 `WalkRecord` 存为本地 JSON。 | P0 | ✅ 已完成 |

### 3.2 游戏化系统 (Gamification) - *New*

| 模块 | 功能点 | 详细逻辑/规则 | 优先级 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| **寻宝** | **随机掉落** | 结算时若距离 > 0.5km，触发随机判定。<br>- **掉落物**：分 Common(垃圾), Uncommon(普通), Rare(稀有), Legendary(传说)。<br>- **传说物品**：**仅通过地图遛狗掉落，不可抽奖获得。** | **P0** | ✅ 已完成 |
| **经济** | **骨头币 (Earn)** | 每遛狗 **1 km = 10 骨头币**。结算时显示获取动画。 | **P0** | ✅ 已完成 |
| **经济** | **抽奖 (Burn)** | 入口：收藏柜页面。<br>消耗：**100 骨头币/次**。<br>产出：随机获得除“传说”以外的物品。若重复则返还 10 币或增加数量。 | P1 | ✅ 已完成 |
| **收藏** | **收藏柜 UI** | 网格展示所有掉落物。<br>- 未解锁：黑色剪影。<br>- 已解锁：彩色图标 + 数量。<br>- 详情弹窗：展示物品大图 + 趣味文案（如“旺财觉得这是个宝剑”）。 | P1 | ✅ 已完成 |

### 3.3 WatchOS 端

| 模块 | 功能点 | 详细逻辑/规则 | 优先级 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| **核心** | **接收与展示** | 接收 iOS 发来的图片。复刻 iOS 端的“动态状态机”逻辑（简单版，如通过颜色或呼吸频率区分心情）。 | P0 | 🚧 进行中 |
| **交互** | **运动控制** | 大号“GO”按钮开始记录。显示实时距离、时长、心率。 | P0 | 🚧 进行中 |

-----

## 4. 数据模型 (Data Structure)

需要在 `Models` 文件夹下建立以下结构。

### 4.1 WalkRecord (历史记录)

```swift
struct WalkRecord: Identifiable, Codable {
    var id: UUID
    let date: Date        // 记录具体的时刻
    let duration: Int     // 秒
    let distance: Double  // 公里
    let mood: String      // 当时心情
    let imageName: String? // 关联的照片
    let itemsFound: [String]? // 本次遛狗捡到的物品 ID 列表
    let bonesEarned: Int  // 本次获得的骨头币
}
```

### 4.2 TreasureItem (宝物图鉴)

```swift
enum Rarity: String, Codable {
    case common, uncommon, rare, legendary
}

struct TreasureItem: Identifiable, Codable {
    let id: String
    let name: String
    let description: String // 趣味文案
    let rarity: Rarity
    let iconName: String
    let isMapExclusive: Bool // 是否仅地图掉落（传说级）
}
```

### 4.3 UserData (全局用户数据)

```swift
struct UserData: Codable {
    var totalBones: Int = 0          // 骨头币余额
    var inventory: [String: Int] = [:] // 物品清单 [ItemID: Count]
    var lastWalkDate: Date?          // 用于计算宠物心情
}
```

-----

## 5. 游戏数值设计 (Balance)

### 5.1 掉落概率表 (参考)

| 稀有度 | 颜色 | 地图掉落率 | 抽奖概率 | 示例物品 |
| :--- | :--- | :--- | :--- | :--- |
| **垃圾 (Common)** | 灰色 | 50% | 60% | 枯树枝, 破网球, 易拉罐 |
| **普通 (Uncommon)** | 绿色 | 35% | 30% | 鹅卵石, 丢失的硬币, 羽毛 |
| **稀有 (Rare)** | 蓝色 | 14% | 10% | 发光玻璃珠, 玩具鸭子 |
| **传说 (Legendary)** | **金色** | **1%** | **0%** | 外星人零件, 龙鳞, 金骨头 |

-----

## 6. UI/UX 设计规范 (Design)

### 6.1 图标与风格

  * **App Icon**: “贴纸足迹”方案。奶油色背景，中间是带白边的西高地贴纸，下方有一串绿色足迹。
  * **主色调**: 奶油白 (`#FFF9F0`) + 活力草地绿 (`#8BC34A`)。

### 6.2 关键界面

1.  **首页**: 宠物大头贴居中（带状态特效），下方是今日目标环和 GO 按钮。
2.  **结算页**:
      * 上半部分：地图轨迹截图（如有）或宠物照片。
      * 数据部分：里程、时间。
      * **奖励部分**: 骨头币增加动画 + 宝箱开启（如有掉落）。
3.  **收藏柜**: 类似于游戏背包，点击物品弹出详细卡片，强调文案的故事性。

-----

## 7. 待办事项清单 (Action Items)

1.  **Model层重构**: 新建 `UserData` 和 `TreasureItem` 模型，确保数据能保存。
2.  **首页逻辑**: 实现 `calculateMood()` 函数，根据最后遛狗时间改变图片透明度或叠加 Emoji。
3.  **结算逻辑**: 编写随机掉落算法 + 骨头币计算逻辑。
4.  **UI开发**: 制作“收藏柜”网格视图和“物品详情”弹窗。
